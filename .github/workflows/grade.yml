name: Auto-Grade Exercise

on:
  push:
    branches: [main, master]

jobs:
  grade:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed exercise
        id: detect
        run: |
          # Find which exercise folder changed
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -E "^m[0-9]" | head -1 || echo "")

          if [ -z "$CHANGED" ]; then
            echo "No exercise files changed"
            echo "exercise_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract module and exercise from path
          MODULE=$(echo "$CHANGED" | cut -d"/" -f1)
          EXERCISE=$(echo "$CHANGED" | cut -d"/" -f2)

          if [ -z "$EXERCISE" ]; then
            echo "Changed file is not in an exercise folder"
            echo "exercise_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          EXERCISE_PATH="$MODULE/$EXERCISE"
          EXERCISE_ID="$MODULE-$EXERCISE"

          echo "Found changed exercise: $EXERCISE_ID at $EXERCISE_PATH"
          echo "exercise_found=true" >> $GITHUB_OUTPUT
          echo "exercise_id=$EXERCISE_ID" >> $GITHUB_OUTPUT
          echo "exercise_path=$EXERCISE_PATH" >> $GITHUB_OUTPUT

      - name: Set up Python
        if: steps.detect.outputs.exercise_found == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pytest
        if: steps.detect.outputs.exercise_found == 'true'
        run: pip install pytest pytest-json-report

      - name: Run tests
        id: test
        if: steps.detect.outputs.exercise_found == 'true'
        continue-on-error: true
        working-directory: ${{ steps.detect.outputs.exercise_path }}
	env:
            PYTHONPATH: .
        run: |
          echo "Running tests for ${{ steps.detect.outputs.exercise_id }}"
          pytest tests/ --json-report --json-report-file=results.json -v || true

          # Parse results
          python3 << 'PYTHON'
          import json
          import os

          try:
              with open("results.json") as f:
                  data = json.load(f)
              passed = data.get("summary", {}).get("passed", 0)
              total = data.get("summary", {}).get("total", 0)
              failed = total - passed
              pct = round(passed / total * 100, 1) if total > 0 else 0
          except:
              passed, failed, total, pct = 0, 0, 0, 0

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"passed={passed}\n")
              f.write(f"failed={failed}\n")
              f.write(f"total={total}\n")
              f.write(f"percentage={pct}\n")
          PYTHON

      - name: Report to LMS
        if: steps.detect.outputs.exercise_found == 'true'
        env:
          WEBHOOK_URL: ${{ secrets.LMS_WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "No webhook URL configured - skipping LMS report"
            exit 0
          fi

          curl -s -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"exercise_id\": \"${{ steps.detect.outputs.exercise_id }}\",
              \"repository\": \"${{ github.repository }}\",
              \"commit_sha\": \"${{ github.sha }}\",
              \"github_username\": \"${{ github.actor }}\",
              \"passed_tests\": ${{ steps.test.outputs.passed || 0 }},
              \"failed_tests\": ${{ steps.test.outputs.failed || 0 }},
              \"total_tests\": ${{ steps.test.outputs.total || 0 }},
              \"percentage\": ${{ steps.test.outputs.percentage || 0 }}
            }"
          echo "Results reported to LMS"
